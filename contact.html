<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Acme Web Design</title>
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.css" />
  <!-- <link rel="stylesheet" href="style.css"> -->
	<style>

		*{
		  box-sizing: border-box;
		}
		#send {
			magin-top: 33px !important;
		}
		body{
		  background:#92bde7;
		  color:#485e74;
		  line-height:1.6;
		  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
		  padding: 0em 1em 3em 1em ;
		}

		.container1{
		  max-width:1100px;
		  margin-left:auto;
		  margin-right:auto;
		  padding: 0em 2em 4em 2em;
		}

		ul{
		  list-style: none;
		  padding:0;
		}

		.brand1{
		  text-align: center;
		}

		.brand1 span{
		  color:#fff;
		}

		.wrapper1{
		  box-shadow: 0 0 20px 0 rgba(72,94,116,0.7);
		}

		.wrapper1 > *{
		  padding: 1em;
		}

		.company-info{
		  background:#c9e6ff;
		}

		.company-info h3, .company-info ul{
		  text-align: center;
		  margin:0 0 1rem 0;
		}

		.contact1{
		  background:#f9feff;
		}

		/* FORM STYLES */
		.contact1 form{
		  display: grid;
		  grid-template-columns: 1fr 1fr;
		  grid-gap:20px;
		}

		.contact1 form label{
		  display:block;
		}

		.contact1 form p{
		  margin:0;
		}

		.contact1 form .full{
		  grid-column: 1 / 3;
		}

		.contact1 form button, .contact1 form input, .contact1 form textarea{
		  width:100%;
		  padding:1em;
		  border:1px solid #c9e6ff;
		}

		.contact1 form button{
		  background:#c9e6ff;
		  border:0;
		  text-transform: uppercase;
		}

		.contact1 form button:hover,.contact1 form button:focus{
		  background:#92bde7;
		  color:#fff;
		  outline:0;
		  transition: background-color 2s ease-out;
		}

		.alert{
		  text-align: center;
		  padding:10px;
		  background:#79c879;
		  color:#fff;
		  margin-bottom:10px;
		  display:none;
		}
		.progress{
		  display:none;
		}
		.progress1{
		  display:none;
		}

		/* LARGE SCREENS */
		@media(min-width:700px){
		  .wrapper1{
			display: grid;
			grid-template-columns: 1fr 2fr;
		  }

		  .wrapper1 > *{
			padding:2em;
		  }

		  .company-info h3, .company-info ul, .brand1{
			text-align: left;
		  }
		}
	</style>	  
</head>
<body>
  <div class="container1">
      <h1 class="brand1"><span>Xuân Mai</span> Corpt</h1>
      <div class="wrapper1">
        <div class="company-info">
          <h3>Trần Văn Nghĩa</h3>
          <ul>
            <li><i class="fa fa-road"></i> 118/63 Bạch Đằng, P.24, Q.BT- HCM </li>
            <li><i class="fa fa-phone"></i> (084) 0903917963</li>
            <li><i class="fa fa-envelope"></i> Nghiatv@gmail.com</li>
          </ul>
      </div>
      <div class="contact1">
        <h3><a href="https://console.firebase.google.com/u/0/project/ketoan-acn1/storage/ketoan-acn1.appspot.com/files/~2Fcontact">Email Us</a></h3>
        <div class="alert">Your message has been sent</div>
        <form id="contactForm">
            <p>
              <label>Họ & tên</label>
              <input type="text" name="name" id="name" required>
            </p>
            <p>
              <label>Công ty</label>
              <input type="text" name="company" id="company">
            </p>
            <p>
              <label>Email</label>
              <input type="email" name="email" id="email" required>
            </p>
            <p>
              <label>Điện thoại</label>
              <input type="text" name="phone" id="phone">
            </p>
            <p>
				<label>Chọn file</label>
				<input class="files" type="file" id="files" multiple />
            </p>			
            <p>
				<button type="button" id="send" style="margin-top: 33px !important;">Upload</button>
            </p>
			<p class="progress">
				<progress value="100" max="100" id="progress" style="width: -webkit-fill-available;"></progress>
			</p>	
            <p class="progress1">
				<input type="text" value="Uploading..." name="fileupload" id="fileupload" />
            </p>						
			
            <p class="full">
              <label>Nội dung tin</label>
              <textarea  name="message" rows="2" id="message"></textarea>
            </p>
          <p class="full">
            <button type="submit">THỰC HIỆN GỬI TIN</button>
          </p>
        </form>
      </div>
    </div>
  </div>

	<!-- <script src="https://www.gstatic.com/firebasejs/4.3.0/firebase.js"></script> -->
	<!-- Firebase App is always required and must be first -->
	
    <script src="https://www.gstatic.com/firebasejs/8.8.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.8.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.8.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.8.0/firebase-storage.js"></script>
    <script>
        // https://console.firebase.google.com/u/2/project/ketoan-acn1/overview
        var firebaseConfig = {
          apiKey: "AIzaSyDlhHYKZqV-M_kUwi0usVusxcsTQK_HOgo",
            authDomain: "ketoan-acn1.firebaseapp.com",
            databaseURL: "https://ketoan-acn1.firebaseio.com",
            projectId: "ketoan-acn1",
            storageBucket: "ketoan-acn1.appspot.com",
            messagingSenderId: "271501131852",
            appId: "1:271501131852:web:93229645df8adef8d074e9"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
    </script>
		<script>
			var files = [];
			document.getElementById("files").addEventListener("change", function(e) {
			  files = e.target.files;
			  for (let i = 0; i < files.length; i++) {
				console.log(files[i]);
			  }
			});

			document.getElementById("send").addEventListener("click", function() {
			  //checks if files are selected
			  if (files.length != 0) {
				//Loops through all the selected files
				for (let i = 0; i < files.length; i++) {
				  //create a storage reference
				  var storage = firebase.storage().ref(`contact/${files[i].name}`);

				  //upload file
				  var upload = storage.put(files[i]);

				  //update progress bar
				  document.querySelector('.progress').style.display = 'block';
				  document.querySelector('.progress1').style.display = 'block';
				  upload.on(
					"state_changed",
					function progress(snapshot) {
					  var percentage =	(snapshot.bytesTransferred / snapshot.totalBytes) * 100;
					  document.getElementById("progress").value = percentage;
					},

					function error() {
					  alert("error uploading file");
					},

					function complete() {
					  <!-- document.getElementById("uploading").value = `${files[i].name} uploaded...`; -->
						storage
							.getDownloadURL()
							.then(function(url) {
								document.getElementById("fileupload").value = url;
								console.log("'Click fileupload.value:",document.getElementById("fileupload").value);
	              setTimeout(function(){
	                document.querySelector('.progress').style.display = 'none';
	                document.querySelector('.progress1').style.display = 'none';
					document.querySelector('.files').value = '';
	              },3000);

							})
							.catch(function(error) {
								console.log("error encountered");
							});
					}
				  );
				}
			  } else {
				alert("No file chosen");
			  }
			});

			document.getElementById("download").addEventListener("click", function() {
				if(files[0]) return getFileUrl(files[0].name);
				console.log('No file uploaded...')
			});

			function getFileUrl(filename) {

			  //create a storage reference
			  var storage = firebase.storage().ref(filename);

			  //get file url
			  storage
				.getDownloadURL()
				.then(function(url) {
				  console.log('Click link : ',url);
				  return url;
				})
				.catch(function(error) {
				  console.log("error encountered");
				});
			}
		</script>

	
	<script>
	
		// Reference messages collection

		// Listen for form submit
		if(document.getElementById('contactForm')){
		  document.getElementById('contactForm').addEventListener('submit', submitForm);

		  var messagesRef = firebase.database().ref('messages');

		  // Test
		  var firetore = firebase.firestore();
		  var data = [] ; // get dữ liệu vào data
		  readFirestore(firetore,'messages')
		  //readFirestore(firetore,'cities')
		  console.log(data);

			// firebase.database().ref('messages/-M6SIIPAC6pOsQybH5pz').once('value').then(function(snapshot) {
		  //   var message = (snapshot.val() && snapshot.val().message) || 'Không tìm thấy !!';
		  //   console.log('message: '+message)
		  // });

		}  

		if(document.getElementById('listData')){
		  document.getElementById('listData').addEventListener('click', submitList);

		}

		//======================================
		//======================================
		function submitList(e){
		  e.preventDefault();

		  if($('#listData')[0].value){
			//alert($('#listData')[0].value) ;
			$('#data_name').val($('#listData')[0].value)
			//console.log($('#data_name').val() ) ;
		  }

		  if($('#listData')[0]['childElementCount'] > 1 ) { return ;} // Ðã nạp rồi

		  if(window.XMLHttpRequest){ XMLHttpRequestObject=new XMLHttpRequest(); }
		  else if(window.ActiveXObject) { XMLHttpRequestObject=new ActiveXObject("Microsoft.XMLHTTP");} 

		  XMLHttpRequestObject.onreadystatechange=function(){
			if (XMLHttpRequestObject.readyState==4 && XMLHttpRequestObject.status==200)
			{
			  var dat = XMLHttpRequestObject.responseText ;
			  dat = jQuery.parseJSON(dat);
			  $.each(dat, function(i, item) {
				 var html = `<option value="`+item +`" >`+ item +`</option>`
				 // console.log(html)
				 $('#listData').append(`<option value="${item}"> ${item} </option>`); 
			  });
			  $('#listData').append(`<option disabled role=separator>──────────</option>`); 

			}
		  }
		  // Get thông tin này trước send cho upload.php để nạp thông tin Database
		  // xong sẽ thực hiện func onreadystatechange() ở trên 
		  var username = getInputVal('username');
		  var password = getInputVal('pwd');
		  XMLHttpRequestObject.open("GET","upload.php?username="+username+"&password="+password,true);
		  XMLHttpRequestObject.send();
		}
		//======================================
		// Submit form
		function submitForm(e){
		  e.preventDefault();

		  // Get values
		  var name = getInputVal('name');
		  var company = getInputVal('company');
		  var email = getInputVal('email');
		  var phone = getInputVal('phone');
		  var message = getInputVal('message');
		  var fileupload = getInputVal('fileupload');
		  var date = new Date().toISOString().replace(/T/, ' ').replace(/\..+/, '')
		 
		  // Save message
		  saveMessage(name, company, email, phone, message, fileupload, date);
		  // Check at :  https://console.firebase.google.com/u/1/project/ketoan-acn1/database/firestore/data~2Fmessages
		  // Show alert
		  document.querySelector('.alert').style.display = 'block';

		  // Hide alert after 3 seconds
		  setTimeout(function(){
			document.querySelector('.alert').style.display = 'none';
		  },3000);

		  // Clear form
		  document.getElementById('contactForm').reset();
		}
		//=====================
		// Function to get get form values
		function getInputVal(id){
		  return document.getElementById(id).value;
		}

		//=====================  Save message to firebase
		function saveMessage(name, company, email, phone, message, fileupload, date){
		  var data = {
			name: name,
			company:company,
			email:email,
			phone:phone,
			message:message,
			fileupload:fileupload,
			date:date,
		  }
		  //===== realtime-Database
		  var newMessageRef = messagesRef.push();
		  var test = newMessageRef.set(data );
		  console.log(test);
		  //==== Cloud-Firestore
		  //var test = firetore.collection("messages").add(data) ;
		  var test = firetore.collection("messages").doc().set(data) ;
		  console.log(test);
		}
		//=======================================
		function  readFirestore(firetore,obj)  {
		  firetore.collection(obj).get()
			.then(function(querySnapshot ) {
			  querySnapshot.forEach(function(doc ) {
				// doc.data() is never undefined for query doc snapshots
				// console.log(doc.id, " => ", doc.data());
				var tmp = doc.data() ;  // Lấy Data
				tmp['id'] = doc.id ;    // Thêm ID
				// tmp.sort(fn($a, $b) => strcmp($a->date, $b->date));
				data.push(tmp);  // push vào data is var public
			});
		  });

		}        
		//=======================================
		function  readcities(firetore)  {
		  firetore.collection("cities").doc("SF")
			.get()
			.then(function(doc) {
			  if (doc.exists) {
				console.log("Document data:", doc.data());
			  } else {
				// doc.data() will be undefined in this case
				console.log("No such document! - add ");
				var citiesRef = firetore.collection("cities");
					citiesRef.doc("SF").set({
						name: "San Francisco", state: "CA", country: "USA",
						capital: false, population: 860000,
						regions: ["west_coast", "norcal"] });

					  }
			}).catch(function(error) {
			  console.log("Error getting document:", error);
			});

		}

	
	
	</script>	

</body>

</html>